---
title: "GlobalPeaceIndex.r"
author: "Ryo Nakagawara"
date: "Sun Sep 18 18:15:16 2017"
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```


世界平和度指数はInstitue for Economics and Peace (IEP)と呼ばれるシンクタンクに作られた指数で、各国と地域の平和度を数値化する試みである。今回はこの世界平和度
指数のデータを`rvest`でWikipediaからウェブスクレープし、`dplyr`、`tidyr`、`stringr`などのデータクリーニングパッケージを使い、最終的に"バンプチャート"というビジュアライゼーションで可視化します。

この記事でRでのデータ分析ワークフローを一歩ずつ説明していきたいと思います。

最初に2017年度のデータから作成された地図を見てみましょう：
![GPI map](https://upload.wikimedia.org/wikipedia/commons/e/e8/GPI_2017.jpg)

最終的にこのデータを他の可視化をして　
では、始めましょう！

```{r ウェブスクレープ}
# Global Peace Index
library(tidyverse)          
library(scales)             
library(ggrepel)            
library(rvest)              
library(stringr)            
library(forcats)            

url <- "https://en.wikipedia.org/wiki/Global_Peace_Index"

GPI <- url %>% 
  read_html() %>% 
  html_nodes('table.wikitable:nth-child(77)') %>%
  .[[1]] %>% 
  html_table(header = TRUE)

```

上記の関数はWikipediaのリンクを保存し、それを`read_html()`の関数に通して、世界平和度指数のデータテーブルがある場所の**CSS Selector** ('table.wikitable:nth-child(77)'の部分)を使ってデータを確保します。この**CSS Selector**をどうやって見つければいいのかを順番に説明しましょう。

＊下記はMozilla Firefoxのブラウザーを使った方法です＊

1.　キーボードで**F12**か**Ctrl + Shift + C** を押し、**Inspector Tool**を出します。
2.　上部のポップアップバーの一番左側のボタンを押します。
3.　マウスでウェブページからスクレープしたい部分に置くとコンソールは自動的にその部分のhtmlコードに移動します。
4.　ハイライトされてあるコードを右クリックして、"Copy"、それで"CSS Selector"を押します。
5.　Rのスクリプトに戻り、上記の用に`html_nodes()`の関数の中にペーストします。
6.　データテーブルが入っているエレメントをセレクトする。(`.[[1]]`)
7.　データテーブルを`html_table()`の関数で引き抜きます。

[**Selector Gadget**]()や他のやり方でウェブページからデータを引き抜く事もできます。

では、Wikipediaから引き抜いたデータを見てみましょう。

```{r}

glimpse(GPI)

```

今回はランキングのデータだけを必要としますので、`select()`のユーティリティー関数、`ends_with()`を利用して"rank"がカラム名の終わりにあるカラムだけを選択します。これを新しいデータフレーム、"GPI_rank"にセーブします。"rank"が入っているカラムを一つ一つ選ぶ必要がないので非常に便利な関数です。

```{r select}

GPI_rank <- GPI %>% select(Country, ends_with("rank"))

colnames(GPI_rank) <- colnames(GPI_rank) %>% tolower()   # 変数名をすべて小文字に変えます

glimpse(GPI_rank)

```

このデータフレームはご覧のとうりwide型になっています。これをtidy化、すなわち各列が個々の変数と各行が個々の観測、に加工するには`tidyr`の`gather()`関数を使います。もっと詳しくはHadley Wickhamの[論文](https://www.jstatsoft.org/article/view/v059i10/v59i10.pdf)を読んでください。

```{r}
GPI_rank <- GPI_rank %>% gather(`2017 rank`:`2008 rank`, key = "year", value = "rank")

glimpse(GPI_rank)

```

次は"year"のカラムから"rank"の文字を消しましょう。`stringr`の`str_replace_all()`で"rank"を"" (ブランク)に変え、`trimws()`で文字列に空白が無い用にしまそう。そのついでに"year"カラムをfactorに変えましょう。

```{r}
GPI_rank <- GPI_rank %>% mutate(year = str_replace_all(year, "rank", "") %>% trimws())

GPI_rank <- GPI_rank %>% mutate(year = as.factor(year))

glimpse(GPI_rank) # levels(GPI_rank$year)

```

また`glimpse()`で　データフレームを見てみると。。。少数の国々が同じGPIランクになっている事が見えます。その国の"rank"カラムには位置の値の前に"＝"が入っていますので、この記号を`stringr`の`str_replace()`関数で消しましょう。その次に"rank"をnumericに変えて、データフレームを`arrange()`で"year", "rank"の順に変えましょう(2008: Rank #1 - #163, 2009: Rank #1 - #163, etc.)。

```{r}
GPI_rank <- GPI_rank %>% 
  mutate(rank = str_replace(rank, "\\=", ""),
         rank = as.numeric(rank)) %>% 
  arrange(year, rank)

glimpse(GPI_rank)

```

## 同じランクの　　を処理



`rank()`関数の"ties.method"引数で同じランクの国々をアルファベット順で並べ替えます。

```{r}
GPI_rank %>% 
  group_by(year) %>% 
  filter(year == 2017) %>% 
  slice(84:85)

# BosniaとBangladeshは同じランク("84")になっています。

GPI_rank %>% 
  group_by(year) %>% 
  mutate(rank = rank(rank, ties.method = "first")) %>% 
  filter(year == 2017) %>% 
  slice(84:85)             # Bangladeshが84位とBosnia & Herzegovinaが85位になりました!

GPI_rank <- GPI_rank %>% 
  group_by(year) %>% 
  mutate(rank = rank(rank, ties.method = "first"))

```

##　ggplot2で可視化！

データクリーニングを終えてやっとggplotを使えます。でもグラフを作る前に、このGPIデータ専用のggplot theme, 名付けて`theme_peace`,を作りましょう！

```{r}
# Create custom theme -----------------------------------------------------
library(extrafont)                 # for fonts in titles and labels

theme_peace <-  
  theme(text = element_text(family = "Garamond", color = "#444444", face = "bold"),
        plot.title = element_text(size = 24, hjust = 0.5),
        plot.subtitle = element_text(size = 12, hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(angle = 0, vjust = 0.5, margin = margin(r = 15)),
        axis.text = element_text(size = 12),
        axis.title.x = element_text(margin = margin(t = 20)),
        legend.title = element_blank(),
        legend.position = "none")

```

`theme()`の関数でグラフの色々な設定をdefaultから変更します。
extrafontのlibraryであらゆるフォントを指定できます。extrafontのインストールの詳細はこの記事をご覧ください。他に注目するオプションは`element_text()`の中のmarginです。このargumentで


これから作るグラフは”バンプチャート”と言い、主には順位の経時的な変化を可視化するビジュアライゼーションです。最初は日本のランキングを重視できるよう、線を赤色に、それで他の国の線はalphaの引数で透明度を変えましょう。`geom_text()`の関数で両端のy-axisに国の名（2008年と2017年のトップ10位）を書き加えます。

```{r fig.height=5, fig.width=8, fig.align='center'}
# Plotting ----------------------------------------------------------------

GPI_rank %>% 
  mutate(jpn = ifelse(country == "Japan", T, F)) %>% 
  ggplot(aes(year, rank, group = country)) +
  geom_line(aes(color = jpn, alpha = jpn), size = 2) +  
  geom_point(aes(color = jpn, alpha = jpn), size = 2.3) +
  geom_text(data = GPI_rank %>% filter(year == "2008", rank <= 10), 
            aes(label = country), color = "black", size = 4, nudge_x = -0.45) +
  geom_text(data = GPI_rank %>% filter(year == "2017", rank <= 10), 
            aes(label = country), color = "black", size = 4, nudge_x = 0.45) +
  scale_y_reverse(breaks = pretty_breaks(10)) +
  scale_x_continuous(breaks = pretty_breaks(10)) +
  scale_color_manual(values = c("#104E8B", "#EE2C2C")) + 
  labs(x = "Year", y = "Rank") +
  ggtitle("Global Peace Index (Top 10)", subtitle = "(2008-2017)") +
  theme_peace +
  coord_cartesian(ylim = c(1, 10.2))

```

可視化しますと日本のGPI順位が年々下がっている事が明らかになります（＊２０１７年はアイルランドと同位でしたが上記のデータクリーニングで日本が11位になりました＊）。これはもしも　近年の　　もしかして

We can clearly see that Japan's ranking has fallen from 2008 and even dropping out of the Top 10 altogether in 2017 (*Note*: technically Ireland and Japan were tied for 10th in 2017)! Could this be a result of the rising tensions in the past 10 years with its neighbors on a number of issues, such as the [East China Sea disputes](https://www.japantimes.co.jp/opinion/2017/08/29/commentary/japan-commentary/japans-maritime-diplomacy-mission-s-e-asia/), the more recent protests regarding the [comfort women issue](https://www.nytimes.com/2017/04/03/world/asia/japan-ambassador-south-korea-comfort-woman.html), and of course North Korea's recent [missile tests](http://www.bbc.co.uk/news/world-asia-41281050) among others? 

日本の下降は東アジアの地方すべてを示す傾向か`filter()`を使って焦点を絞ってみましょう。このグループに南シナ海で領土・権益問題に加わっているフィリピンやベトナムも入れましょう。


```{r}
# Subset custom "East Asia" region -----------------------------------------------

GPI_Asia <- GPI_rank %>% filter(country %in% c("Japan", "China", "Korea Republic", "DPR Korea", 
                                               "Philippines", "Taiwan", "Vietnam")) %>% 
  mutate(region = "East Asia")

glimpse(GPI_Asia)

GPI_Asia$rank <- as.numeric(GPI_Asia$rank)

```

これで準備完了！

```{r fig.height=5, fig.width=8, fig.align='center'}
# Plot "East Asia" region -------------------------------------------------
GPI_Asia %>%
  ggplot(aes(year, as.numeric(rank), group = country)) +
  geom_line() +
  geom_point() +
  geom_text(data = GPI_Asia %>% filter(year == "2008"), 
                  aes(label = country, x = "2008"), color = "black", size = 4, nudge_x = -1.1) +
  geom_text(data = GPI_Asia %>% filter(year == "2017"), 
                  aes(label = country, x = "2017"), color = "black", size = 4, nudge_x = 1.1) +
  scale_y_reverse(breaks = c(1, 5, seq(10, 160, by = 10))) +
  scale_x_discrete(expand = c(0.1, 0.05)) +
  labs(x = "Year", y = "Rank") +
  ggtitle("Global Peace Index (East Asia Region)\n (2008-2017)") +
  theme_peace

```

There could still be some improvements made to this plot, specifically, the country labels on either side of the x-axis limits. We can also manually set colors to each of our custom "East Asia" region countries to further differntiate each line and make it more easy to read:

まだ改善できる所がありますね。

`gg_repel`のパッケージで文字列が重なり合わない用にします。ついでに各国に色を指定しましょう。色は"red", "blue"等名前だけではなく、RではHEX値も使えます、詳しくは　を見てください。

```{r}

colors = c(
  Japan = "#EE2C2C",          # red
  S.Korea = "#0c2c84",        # dark blue
  China = "#00441b",          # green
  N.Korea = "#4a1486",        # purple
  Vietnam = "#636363",        # dark grey
  Philippines = "#fd8d3c",    # orange
  Taiwan = "#000000"          # black
)
```

次、`country`をfactor型に変え、`fct_recode()`で"Korea Republic"と"DPR Korea"をプロットで分かりやすい名前("S.Korea"と"N.Korea")に変えましょう。

```{r fig.height=5, fig.width=8, fig.align='center'}

GPI_Asia <- GPI_Asia %>% 
   mutate(country = as.factor(country),
          country = fct_recode(country,
                                 "S.Korea" = "Korea Republic",
                                 "N.Korea" = "DPR Korea"))

GPI_Asia %>%
  ggplot(aes(year, as.numeric(rank), group = country)) +
  geom_line(aes(color = country)) +
  geom_point(aes(color = country)) +
  geom_label_repel(data = GPI_Asia %>% filter(year == "2008"), 
                  aes(label = country, x = "2008"), 
                  color = "black", size = 3.5, nudge_x = -0.9, 
                  fontface = "bold", segment.colour = "red") +
  geom_label_repel(data = GPI_Asia %>% filter(year == "2017"), 
                   aes(label = country, x = "2017"), 
                   color = "black", size = 3.5, nudge_x = 1.5,
                   fontface = "bold", segment.colour = "red") +
  scale_y_reverse(breaks = c(1, 5, seq(10, 160, by = 10))) +
  scale_x_discrete(expand = c(0.2, 0.05)) +
  labs(x = "Year", y = "Rank") +
  ggtitle("Global Peace Index (East Asia Region)\n (2008-2017)") +
  theme_peace +
  scale_color_manual(values = colors)

```

勿論、ランキングの変化はすべて国際的な理由で変わっている訳ではありません、「近隣国との関係」はGPIスコアを計算する23個の指標の一つでしかありません。他には殺人事件数、GDPに対する軍事費の比率、政治不安定さ等の項目からGPIが計算されています。詳細は最新の(GPIレポート)[http://visionofhumanity.org/app/uploads/2017/06/GPI17-Report.pdf]のアペンディックスBを呼んで下さい。

今度はわざわざ新しいデータフレーム(例えGPI_Asia)を作るより、`ggplot()`関数の前に`magrittr`のパイプで`filter()`や`mutate()`を使いましょう。

次に`mutate()`で`region`(地方)のカラムを作ります。`region`はブーリアン型のカラムで`country`が先ほど定義した国々だと"East Asia"になり、他の国は"Other"になります。それでfilter()で"East Asia"だけを選択しggplotにパイプします。

```{r fig.height=6, fig.width=8, fig.align='center'}
# Final plot: East Asia ---------------------------------------------------

GPI_rank %>%
  mutate(country = fct_recode(country,
                              "S.Korea" = "Korea Republic",
                              "N.Korea" = "DPR Korea"))　 %>% 
  mutate(region = if_else(
    country %in% c("Japan", "China", "S.Korea", "N.Korea", "Philippines", "Taiwan", "Vietnam"), 
    "East Asia", "Other")) %>% 
  filter(region == "East Asia") %>% 
  ggplot(aes(year, rank, group = country)) +
  geom_line(aes(color = country), size = 1.2, alpha = 0.8) +
  geom_point(aes(color = country), size = 1.1, alpha = 0.5) +
  geom_label_repel(
    data = GPI_rank %>% 
      filter(year == "2008", region == "East Asia"), 
    aes(label = country), 
    color = "black", family = "Times New Roman", fontface = "bold",
    size = 4, nudge_x = -0.9) +
  geom_label(
    data = GPI_rank %>% 
      filter(year == "2017", region == "East Asia"), 
    aes(label = country), 
    color = "black", family = "Century", fontface = "bold",
    size = 4, nudge_x = 0.9) +
  scale_y_reverse(breaks = c(1, seq(10, 160, by = 10))) +
  scale_x_discrete(expand = c(0.2, 0.05)) +
  labs(x = "Year", y = "Rank") +
  ggtitle("Global Peace Index (East Asia Region)\n (2008-2017)") +
  theme_peace +
  scale_color_manual(values = colors)

```

With the colored lines and the labels we can clearly see the downward trend of GPI rankings for all countries in the East Asia region. The exception is Taiwan which although shown as 37th in 2008, it was technically tied with Tunisia and South Korea, and they basically reverted back to their actual 2008 rank (40th) after a brief rise.  

色を付けた線とレッテルで東・東南アジアのランクが徐々に下降している傾向が明らかに見えます。例外は　　台湾。

このブログポストではデータ　から可視化まで　　ステップーバイーステップにて
あんまり深く探りませんでしたがEDAとしてはいい例だと思っています　参考になれば幸いです。

Hopefully with initiatives like the GPI and the works of other peace-oriented think tanks, the public can identify different sources of problems that hinder peaceful co-existence both within-countries and between-countries and assist policy-makers in finding viable solutions!

GPIのような指数や他の和平　シンクタンクの活動で　大衆　政治家　国家機関　　が　もっと簡単に　

なぜ治安が悪化しているのかを

要因　　原因　等を特定できるように

分析　　解析でくるよう



英語も読める方はぜひ他のブログ記事を読んでください。次に翻訳するブログ記事は昨年投稿した[Thrice Part 1]()だと考えています。






